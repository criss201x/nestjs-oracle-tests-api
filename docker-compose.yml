version: '3.8'

services:
  oracle-db:
    image: gvenzl/oracle-xe:18-slim
    container_name: oracle19c
    ports:
      - "1521:1521"
    environment:
      - ORACLE_PASSWORD=OraclePass123
      - ORACLE_DATABASE=TESTDB
    volumes:
      - oracle-data:/opt/oracle/oradata
      - ./script_prueba.sql:/container-entrypoint-initdb.d/01_init.sql      
    shm_size: 1g
    networks:
      - oracle-net
    healthcheck:
      test: ["CMD", "sqlplus", "-L", "system/OraclePass123@//localhost:1521/XE", "<<< \"SELECT 1 FROM DUAL;\""]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 60s

  api:
    build: ./api
    container_name: nestjs-api
    ports:
      - "3000:3000"
    environment:
      - DB_HOST=oracle-db
      - DB_PORT=1521
      - DB_SID=XE      
      - DB_USER=system
      - DB_PASSWORD=OraclePass123
    volumes:
      - ./api:/app
      - /app/node_modules
    depends_on:
      oracle-db:
        condition: service_healthy
    networks:
      - oracle-net
    command: npm run start:dev
    restart: on-failure

  cloudbeaver:
    image: dbeaver/cloudbeaver:latest
    container_name: oracle-cloudbeaver
    ports:
      - "8978:8978"
    volumes:
      - cloudbeaver-data:/opt/cloudbeaver/workspace
    networks:
      - oracle-net

volumes:
  oracle-data:
    driver: local
  cloudbeaver-data:
    driver: local

networks:
  oracle-net:
    driver: bridge